# turtlebotMatlab

Waypoint following with obstacle avoidance using turtlebot Matlab

임베디드 시스템 기반의 추적제어시스템 설계, 즉, 자율 주행 자동차, 드론, 모바일 로봇 등 영상 정보를 활용하는 제어 시스템의 안정성 및 제어 방법에 대해 이해하고 자율 주행 시스템을 위한 ROS 기반의 제어시스템 설계를 목표로 하였고 이러한 제어시스템을 개발하기 위해서는 하드웨어 및 소프트웨어 모두를 설계 및 테스트 할 수 있는 기술 뿐 아니라 제어기술 분야의 종합적인 지식이 필요했습니다. 

카메라를 통해 영상 인식, 검출, 상황 인식 등의 기술들을 활용하여 다양한 환경 변화에도 안정성과 성능을 보장하는 자율 주행하는 기능을 적절히 수행할 수 있는 하드웨어를 설계하는 부분, 그리고 영상데이터를 처리하여 인식한 후 이를 추적하는 소프트웨어를 개발하는 부분, 그리고 특정물체와 모바일 로봇 사이의 에러 동적모델에 대한 제어기를 설계하여 서보모터를 구동하는 세 부분으로 나누어 접근했고 이 과정을 임베디드 시스템 기반으로 구현하기 위해 모바일로봇 Turtlebot3와 영상처리기반의 임베디드 개발용 키트 Raspberry pi가 사용되었습니다.



과제의 배경 및 필요성

(1) 기술적 측면
4차 산업혁명의 여러 가지 기술들 중 많은 관심을 받는 분야 중 하나가 바로 자율주행차이다. 자동차와 ICT를 융합하는 것으로 시작하여, 빅데이터 기술까지 사용하는 자율주행차는 현재의 자동차 산업을 크게 뒤바꿀 것으로 예상된다. 미국의 리서치 조사 업체인 Navigant Research의 2013년 3분기 보고서에 따르면 자율주행차 시장 규모가 2035년에 743조원으로 성장하고 세계 3대 시장(유럽, 미주, 아시아)에서 자율주행차 보급 규모가 2035년 9,540만대로 연평균 85% 성장할 것이라고 전망했다.
 자율주행차는 기존 자동차에 ICT기술을 도입한 신기술이다. 스스로 주행 환경을 인식하고, 위험을 판단하며, 경로를 계획하는 등 운전자의 조작을 최소화하여 스스로 운행하는 자동차를 말한다. 주행단계에는 인지-판단-조작의 3단계가 있다. 인지 단계는 상황을 감지하는 단계이고 판단단계는 속도조절 및 조향 등 중앙제어를 말하며 조작단계는 엑추에이터를 말한다.
자율주행차는 인지-판단-조작으로 나뉘며 인지와 판단이 되는 부분이 핵심이 되는 만큼 자율주행기술의 핵심은 인지-판단 알고리즘을 구현하기 위한 데이터를 받아들이고 이를 처리하는 부분이 핵심이 된다. 실제로 다양한 알고리즘과 그것을 구현하기 위한 하드웨어들이 개발되어지고 있다. 현재 각 업체들이 자율주행에 이용하는 기술들은 모두 크게 다르지 않으며, 많은 데이터와 딥러닝을 이용한 학습이 기반이 되어 있기 때문에, 자율주행에 필요한 하드웨어를 탑재한 차량이 많이 보급될수록 자율주행 차량의 지능은 더욱 발전할 것이다.
이와 같은 자율주행자동차의 연구사례와 기술의 흐름을 볼 때, 자율주행차를 구현하고 그 성능을 보다 향상시키기 위한 핵심기술은 바로 인식-판단의 알고리즘과 그것을 구현할 수 있는 하드웨어이다. 따라서 이러한 인식-판단 알고리즘을 구현하고 이를 구동할 수 있는 하드웨어를 설계할 수 있는 능력이 절대적으로 요구된다. 본 프로젝트는 영상처리 기반의 임베디드 개발보드와 임베디드 컨트롤러를 이용하여 영상처리 기반의 자율추적제어 시스템을 설계함으로써 자율주행차를 구현하기 위한 필수 능력인 알고리즘을 구현(소프트웨어)하고 하드웨어를 설계하는 능력을 함양하는데 그 목적이 있다.

(2) 산업/경제적 측면
대부분의 측면은 모두 기술적 측면에서 설명하였다. 이러한 점들은 산업/경제적 측면에도 같이 적용된다. 4차 산업혁명에서 가장 대두되고 있는 것이 인공지능과 밀접한 연관을 갖고 있으며, 이는 우리의 IT발전에 큰 영향을 미칠 것이다. 그리고 이러한 인공지능의 발달로 기술력을 갖게 되며 경제적으로도 큰 이익을 가져올 수 있을 것이다.



과제의 최종목표 

 자율주행 자동차, 드론, 모바일 로봇 등 영상 정보를 활용하는 제어 시스템의 안정성 및 제어 방법을 연구하는 ROS 기반의 제어를 이해한다. 자율주행 제어시스템 설계에 필요한 하드웨어 및 소프트웨어의 종합적인 설계 및 테스트를 하여 물체를 인식하고 추적 제어하는 로봇의 알고리즘을 개발한다. 팀 단위 프로젝트 진행방식으로 팀 내의 협동능력, 리더쉽을 발휘할 수 있는 능력과 커뮤니케이션 능력을 함양한다. 공학설계 과정을 이해하고 실제로 응용할 수 있도록 한다.
 중간 테스트 목표로서 추적제어에 필요한 기본적인 기능을 테스트한다. 목표 지점을 원격으로 지정하여 도달하는 위치 및 속도를 제어한다. 이때 카메라와 레이더 센서를 활용하여 인식하고 제어한다. 최종 테스트 목표로서 ROS 기반의 자율주행 추적 시스템을 설계한다. 3mX3m 크기의(혹은 더 작을 수 있다.) 사각 안에서 회피자와 추적자 역할에 따른 자율주행을 시행한다. 회피자는 추적자로부터 회피한 시간을 기록하고 추적자는 회피자를 터치하는데 까지 걸린 시간을 기록한다. 4개의 파란색 원으로 된 타겟 마크를 표시한다. 로봇의 제한 속도는 0.5m/s이다.(로봇 자체의 최고 속도가 보다 작을 경우 최고 속도로 제한한다.) 탈락 조건은 제한 속도를 초과했을 때와 지정된 크기의 사각을 벗어났을 때로 정한다.



과제의 내용

 로봇 시뮬레이터라고 언급한 Gazebo란 알고리즘을 신속하게 테스트하게 도와줄 수 있고 로봇 설계에 대한 feedback을 제공해 준다. 또한 다양한 시나리오로 AI 시스템을 학습하는데 효율적이다. 결과적으로 이를 통해 ROS 환경을 더 자세히 이해할 것이고 이것은 로봇 제어에 대한 직접적인 첫 번째 접근이 될 것이다. 이렇게 유용한 ROS를 로봇 제어를 위해 바로 이용한다면 좋지만 아직 미숙하기 때문에 다른 소프트웨어의 도움이 필요하다. 그래서 두 번째 단계로 Matlab 환경에서 지원하는 ROS를 이용하여 로봇을 제어하는 연습을 한다. 2016버전 이상의 Matlab에서는 라이브러리를 통해 로봇을 직접 제어하거나 혹은 Gazebo라는 로봇 시뮬레이터를 이용하여 테스트를 해볼 수 있다. 직접 제어하는 방법은 Matlab을 이용하여 스크립트로 코딩하는 방법이 있다. 또는 Matlab에 있는 Simulink는 ROS를 엑세스할 수 있게 도와주는데 어려운 코드 대신에 블록 다이어그램을 이용해서 코딩할 수 있다. 또한 ROS node의 상태를 실행하거나 중지, 확인을 Matlab을 통해 할 수 있게 해준다. 다음 세 번째로 자율주행 로봇의 실제적인 동작 모습을 살펴볼 것이다. 이때 사용할 로봇은 터틀봇3 버거이다. 터틀봇3는 모듈 식으로 사용자가 자유롭게 정의하여 사용할 수 있는 모바일 로봇이다. 또한 컴퓨터 및 센서와 같은 옵션 부품을 사용할 수 있다. 사용하기 쉽기 때문에 ROS 기반으로 한 교육, 연구 및 제품 개발에 많이 쓰이고 있다. SBC는 컴퓨터 기능에 필수적인 마이크로프로세서, 메모리, 입출력 등의 기능이 있는 단일 회로 기판으로 구성된 초소형 컴퓨터로서 터틀봇3 버거는 라즈베리 파이3를 쓰고 있다. 임베디드 컨트롤러로서는 OpenCR을 사용하고 있다.OpenCR은 ROS 임베디드 시스템을 제어하기 위해 개발된 오픈 소스 하드웨어 및 소프트웨어이다. 터틀봇3 버거에 쓰이는 OpenCR은 ARM Cortex-M7을 사용하고 있지만 ARM asm을 몰라도 Arduino IDE를 지원하기 때문에 학생들이 사용하기에도 쉽다. 확장 보드 또는 다양한 센서와 인터페이스할 수 있는 디지털 및 아날로그 입출력 핀도 제공한다. 또한 PC에 연결하기 위한 USB와 다른 임베디드 장치용 UART, SPI, I2C, CAN 등 다양한 통신 인터페이스를 제공한다. 터틀봇3에는 와플이라는 다른 모델이 있지만 버거를 사용하는 이유는 속도에서 큰 차이가 없지만 회전 속도가 버거가 더 우수하기 때문이다. 현재 단계에서는 추적보다 터틀봇3의 구동 자체가 주목적이지만 그 다음 목표인 최종 목표에서는 타겟 로봇을 카메라로 추적하고 방향을 정한 뒤 동작을 결정해야 하기 때문에 회전이 빠를수록 더 쉽게 탐색할 수 있다. 네 번째로는 위에서도 잠시 언급했듯이 실제 다른 로봇을 추적하는 목표를 달성하는 것이다. 이를 위해 추가적으로 필요한 것이 라즈베리 파이3 카메라 모듈이다. 이 카메라는 라즈베리 파이3에서 효율적으로 사용할 수 있도록 나온 전용 카메라이다. 이 카메라를 선택한 이유는 적당한 해상도에 가격도 합리적이고 터틀봇3 버거에 내장된 라즈베리 파이3와 연동도 쉽기 때문이다. 라즈베리 파이의 CSI(Camera Interface) 포트에 끼우는 형식으로 사용할 수 있다. 라즈베리 파이 카메라는 USB 웹캠과 다르게 연결 되서 사진이 잘 찍혀도 OpenCV라는 영상처리를 도와주는 라이브러리로 접근할 수 없다. USB 타입으로 연결하지 않기 때문에 MMAL이라는 라이브러리를 이용해서 장치를 제어해야 한다. 이것은 라즈베리 파이의 영상 처리는 VideoCore 기반이고 리눅스의 영상 처리는 V4L2(Video for Linux2) 기반으로 서로 다르기 때문이다. 카메라 모듈을 이용하여 영상으로 받아들이고 받아들인 영상 정보를 이용하여 효과적으로 상대 로봇을 추적하는 알고리즘을 만드는 것이 목표이다. 이 과정에서 단순히 상대 로봇을 찾는 것만이 아니라 다양한 추가 조건들(속도, 범위)을 충족시키며 동작해야 할 것이다. 프로젝트의 개발 프로세서로는 시스템 모델링, 컨트롤러 디자인, 개발 환경설정, 이미지 프로세싱의 단계를 거친다. 시스템 모델링에서는 모바일 로봇을 모델링하고 동적인 모델의 에러를 체크, 시뮬레이션을 하는 작업을 한다. 컨트롤러 디자인에서는 컨트롤러 디자인을 피드백해보고 비선형 시뮬레이션을 한다. 개발환경설정 단계에서 터틀봇3와 설치된 Robotic toolbox, ROS toolbox를 이용하여 ROS node test를 하여 이미지 프로세싱 단계에서 물체를 탐지하는 역할을 한다. 현재 예상하고 있는 개발범위는 첫 번째로 Matlab 환경에서 ROS툴을 이용하여 자율주행하는 터틀봇3 버거, 두 번째로 정상 작동하는 터틀봇3 버거가 카메라 센서를 통해 받아들인 정보를 이용하여 분석, 평가하는 알고리즘을 개발하여 스스로 상대 로봇을 탐색하고 회피하거나 추적할 수 있게 로봇을 제어 하는 것이다.



현실적 제한조건

-경제성: 제품 제작하는데 있어 필요한 비용을 최소화해야 하므로 LADAR 센서, IR 센서, 이미지 센서를 최소한으로 사용하여 정보를 얻어야 한다, 우리가 제작하는 설계제품에 필요한 성능을 만족하되 과도한 제품 향상을 위한 불필요한 지출은 줄인다.
-안전성: 설계된 제품은 제작이나 사용에 있어 안전해야 한다.
-신뢰성: 설계된 제품은 의도된 대로 동작하여야 한다. 같은 조건에서 같은 결과를 내도록 설계될 뿐 아니라 주변 환경의 변화에도 불구하고 성능 기준을 만족시킬 수 있어야 한다. 예) 0~100도 온도 범위에서 SNR 60dB 이상, 전원전압 5V±1V 범위에서 정상 동작 
-외관성: 터틀봇 기본 규격 크기를 크게 벗어나지 않도록 하며 모든 상황에서 안정된 상태로 동작 가능하도록 제작 할 수 있도록 한다.
-윤리성: 설계된 제품은 제반 법 규정을 준수해야 하며 다른 이의 지적재산권을 침해하여서는 안 된다. 사회통념상 받아들일 수 없는 용도로 사용 되는 것을 목적으로 설계되어서는 안 된다, 라이다 센서 및 카메라 센서로 얻은 위치와 이미지는 시스템을 동작을 위함에만 쓰여야 하며 개인의 이익을 위해서 사용해서는 안 된다.
-사회적 영향: 추적 및 회피의 기능은 여러 로봇분야에서 쓰이므로 적은 전력으로 오랜 시간 동작할 수 있도록 제작한다.



과제의 수행내용

-경제성: 비용에 맞는 제품의 LIDAR센서, IR 센서, 이미지센서등의 성능이 좋지 않아 다른 물체를 인식하는 작업에 있어 센서들을 같이 사용하여 정확도를 높였다.
-안전성: 제작 및 사용단계에서 안정하도록 알고리즘을 설계하였다.
-신뢰성: 정상 상태에서 올바른 동작을 하며 매번 다른 결과가 아닌 알고리즘으로 짜여진 결과물이 도출 되도록 하였다.
-외관성: 매뉴얼대로 터틀봇을 제작하여 외관상 기본 규격과 크기에 벗어나지 않게 제작하였다.
-윤리성: 일반 직진속도는 0.2m/s로 제한을 두었으며 인명구조를 도와주는 로봇의 역할을 하는 목적으로 로봇을 설계하였다.
-사회적 영향: 추적 및 회피 알고리즘을 이용하여 최대한 빠르게 추적하고 느리게 잡히게 만들었다.



과제의 수행과정

1)  터틀봇3 조립 및 라즈베리파이 운영체제 설치, 카메라 설치
2)  원하는 좌표로 이동하는 코드 작성
3)  장애물을 인지하고 회피하는 코드 작성
4)  목표를 인지하고 목표의 좌표를 가져오는 코드 작성
5)  자신의 위치에서 근처 지형을 그리는 매핑 코드 작성
6)  작성한 코드들은 통합하여 하나의 시스템 완성


과제의 수행결과 

 과제는 최종 결과물을 얻기 위해 그 전에 기반이 되는 기술들을 중간지점까지 완성을 시켰다. 중간목표는 터틀봇을 원하는 좌표로 이동하기, 장애물 회피 후 목표지점 이동하기, 목표 물체와 거리 유지하기로 총 3가지 목표가 있었다. 장애물 회피는 라이다 센서, 목표 물체와 거리유지는 라즈베리파이3 V2 카메라를 사용하여 수행하였고 제어기의 기반이 되는 목표지점으로 이동하기는 키네마틱 운동을 이용하여 알파, 베타, 로우값을 설정하여 선형화 시켜준후 제어를 하였다. 
 최종 목표는 1.5m x 1.5m 정사각형 틀안에 3개의 장애물이 있는 환경에서 상대 로봇과 추적 및 회피를 통하여 상대적 평가를 받는 것이었다. 물체를 찾기위해 카메라 focal length를 구하여야만했다. Calibration을 실행하여 현재 카메라에 맞는 focal length를 구하였다. 카메라를 통하여 물체가 들어오면 라이다로 위치를 받아올수있게 구현하였다. 장애물을 효과적으로 피하며 목표물을 추적, 회피를 위해 라이다를 이용한 맵핑 및 패스플래닝을 적용하여 가장 효율적으로 움직이게 만들었다. 결론적으로 사용자가 프로그램을 입력 시켜주면 자율 주행을 하고 원하는 물체에 추적, 회피가 가능한 로봇을 제작하였다.


과제의 성과 및 기대효과

*과제 결과의 기여도 
  우리은행에서 사용되고 있는 ‘페페’라는 로봇이 은행에 오는 고객에게 알맞은 업무를 선택하는데 도와주는 역할을 담당하고 있고 또한 인천공항에 있는 ‘에어스타’의 경우처럼 일정장소를 자율주행하며 청소, 안내, 자동적으로 충전을 하는 로봇이 벌써 상용화가 되어 있다. 이번 프로젝트를 통해 상용화된 레벨의 로봇을  만드는 것은 아니지만 그에 바탕이 되는 로봇을 제작하는 경험을 통해 미래 4차 산업혁명에 이바지 할 수 있을 것으로 생각된다.
 또한 프로젝트를 통해 제어시스템과 하드웨어, 소프트웨어를 종합적으로 설계하는 능력을 키워 진로선택에 폭을 넓혀 주고, 팀내의 커뮤니케이션 능력을 향상시켜 향후 사회집단에 큰 도움이 될 것으로 생각된다.                     

*과제 결과의 활용방안
 과제의 최종목표인 추적/제어 알고리즘을 개발하기 위해 선행되는 물체 탐지, 이미지 인식 기술을 활용하여 차선 검출, 보행자 인식, 및 차량 검출 기술 개발에 활용 가능하다. 다중 센서들로 수집된 데이터들은 인공지능, 빅데이터 기술들과 접목하여 활용되며 자율 주행 기술 개발 속도를 향상시킬 수 있다.

과제 수행 후 소감

처음 받았던 이 과제는 정말 막막했다. ROS에 대한 지식도 크게 가지고 있지 않았으며, 처음 접해본 분야였기 때문에 어디서부터 시작을 해야할지 갈피를 잡지 못했다. 하지만 공부를 하고 차차 알아가다 보니 계속 지식을 가지게 되는 재미를 알게 되었다. 처음 로봇이 움직일 때는 소리를 지를만큼 좋았고, 성취감도 들었다. 뒤에는 점점 어려운 과제가 나오며 머리가 아팠지만 만들어낸 결과물을 보니 뿌듯했고 한편으론 아쉬웠다. 아직 2학기때 같은 주제로 할 수 있는 기회가 남아있는데, 이때는 아쉽지 않을 만큼 좋은 결과물을 낼 수 있을 것이라 믿는다.
